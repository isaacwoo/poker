<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å·æ‰‘å…‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #1a472a;
        overflow: hidden;
    }

    /* ç®€æ´æ¨¡å¼æ ·å¼ */
    body.stealth-mode {
        background: white;
    }

    body.stealth-mode poker-table {
        --bg-color: white;
        --text-color: #333;
        --card-bg: white;
        --border-color: #e0e0e0;
        --chip-color: #666;
    }

    /* åˆ‡æ¢æŒ‰é’® */
    .mode-toggle {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(0,0,0,0.7);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }

    body.stealth-mode .mode-toggle {
        background: white;
        color: #666;
        border: 1px solid #e0e0e0;
        font-size: 12px;
        padding: 6px 12px;
    }

    .mode-toggle:hover {
        opacity: 0.8;
    }

    poker-table {
        display: block;
        width: 100vw;
        height: 100vh;
    }
</style>
```

</head>
<body class="stealth-mode">
    <button class="mode-toggle" onclick="toggleMode()">æ¸¸æˆæ¨¡å¼</button>
    <poker-table></poker-table>

```
<script>
    // æ‰‘å…‹ç‰Œç›¸å…³å¸¸é‡å’Œå·¥å…·å‡½æ•°
    const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
    const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const RANK_VALUES = { '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14 };

    // æ‰‹ç‰Œç±»å‹
    const HAND_RANKS = {
        HIGH_CARD: 0,
        PAIR: 1,
        TWO_PAIR: 2,
        THREE_OF_KIND: 3,
        STRAIGHT: 4,
        FLUSH: 5,
        FULL_HOUSE: 6,
        FOUR_OF_KIND: 7,
        STRAIGHT_FLUSH: 8,
        ROYAL_FLUSH: 9
    };

    const HAND_NAMES = {
        0: 'é«˜ç‰Œ',
        1: 'ä¸€å¯¹',
        2: 'ä¸¤å¯¹',
        3: 'ä¸‰æ¡',
        4: 'é¡ºå­',
        5: 'åŒèŠ±',
        6: 'è‘«èŠ¦',
        7: 'å››æ¡',
        8: 'åŒèŠ±é¡º',
        9: 'çš‡å®¶åŒèŠ±é¡º'
    };

    // åˆ›å»ºä¸€å‰¯ç‰Œ
    function createDeck() {
        const deck = [];
        for (let suit of SUITS) {
            for (let rank of RANKS) {
                deck.push({ suit, rank, value: RANK_VALUES[rank] });
            }
        }
        return deck;
    }

    // æ´—ç‰Œ
    function shuffleDeck(deck) {
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        return deck;
    }

    // è¯„ä¼°æ‰‹ç‰Œ
    function evaluateHand(cards) {
        if (cards.length < 5) return { rank: HAND_RANKS.HIGH_CARD, value: 0, name: 'é«˜ç‰Œ' };

        const allCombinations = getCombinations(cards, 5);
        let bestHand = { rank: -1, value: 0, cards: [], name: '' };

        for (let combo of allCombinations) {
            const hand = evaluateFiveCards(combo);
            if (hand.rank > bestHand.rank || (hand.rank === bestHand.rank && hand.value > bestHand.value)) {
                bestHand = hand;
            }
        }

        return bestHand;
    }

    // è·å–æ‰€æœ‰5å¼ ç‰Œçš„ç»„åˆ
    function getCombinations(arr, k) {
        if (k === 1) return arr.map(x => [x]);
        const combinations = [];
        for (let i = 0; i <= arr.length - k; i++) {
            const head = arr.slice(i, i + 1);
            const tailCombos = getCombinations(arr.slice(i + 1), k - 1);
            for (let combo of tailCombos) {
                combinations.push(head.concat(combo));
            }
        }
        return combinations;
    }

    // è¯„ä¼°5å¼ ç‰Œ
    function evaluateFiveCards(cards) {
        const sortedCards = [...cards].sort((a, b) => b.value - a.value);
        const ranks = sortedCards.map(c => c.value);
        const suits = sortedCards.map(c => c.suit);

        const isFlush = suits.every(s => s === suits[0]);
        const isStraight = ranks.every((r, i) => i === 0 || ranks[i - 1] - r === 1) ||
                          (ranks[0] === 14 && ranks[1] === 5 && ranks[2] === 4 && ranks[3] === 3 && ranks[4] === 2);

        const rankCounts = {};
        ranks.forEach(r => rankCounts[r] = (rankCounts[r] || 0) + 1);
        const counts = Object.values(rankCounts).sort((a, b) => b - a);

        // çš‡å®¶åŒèŠ±é¡º
        if (isFlush && isStraight && ranks[0] === 14 && ranks[4] === 10) {
            return { rank: HAND_RANKS.ROYAL_FLUSH, value: 10000, cards: sortedCards, name: 'çš‡å®¶åŒèŠ±é¡º' };
        }

        // åŒèŠ±é¡º
        if (isFlush && isStraight) {
            return { rank: HAND_RANKS.STRAIGHT_FLUSH, value: 9000 + ranks[0], cards: sortedCards, name: 'åŒèŠ±é¡º' };
        }

        // å››æ¡
        if (counts[0] === 4) {
            const fourRank = Object.keys(rankCounts).find(k => rankCounts[k] === 4);
            return { rank: HAND_RANKS.FOUR_OF_KIND, value: 8000 + parseInt(fourRank), cards: sortedCards, name: 'å››æ¡' };
        }

        // è‘«èŠ¦
        if (counts[0] === 3 && counts[1] === 2) {
            const threeRank = Object.keys(rankCounts).find(k => rankCounts[k] === 3);
            return { rank: HAND_RANKS.FULL_HOUSE, value: 7000 + parseInt(threeRank), cards: sortedCards, name: 'è‘«èŠ¦' };
        }

        // åŒèŠ±
        if (isFlush) {
            return { rank: HAND_RANKS.FLUSH, value: 6000 + ranks[0], cards: sortedCards, name: 'åŒèŠ±' };
        }

        // é¡ºå­
        if (isStraight) {
            return { rank: HAND_RANKS.STRAIGHT, value: 5000 + ranks[0], cards: sortedCards, name: 'é¡ºå­' };
        }

        // ä¸‰æ¡
        if (counts[0] === 3) {
            const threeRank = Object.keys(rankCounts).find(k => rankCounts[k] === 3);
            return { rank: HAND_RANKS.THREE_OF_KIND, value: 4000 + parseInt(threeRank), cards: sortedCards, name: 'ä¸‰æ¡' };
        }

        // ä¸¤å¯¹
        if (counts[0] === 2 && counts[1] === 2) {
            const pairs = Object.keys(rankCounts).filter(k => rankCounts[k] === 2).map(Number).sort((a, b) => b - a);
            return { rank: HAND_RANKS.TWO_PAIR, value: 3000 + pairs[0] * 20 + pairs[1], cards: sortedCards, name: 'ä¸¤å¯¹' };
        }

        // ä¸€å¯¹
        if (counts[0] === 2) {
            const pairRank = Object.keys(rankCounts).find(k => rankCounts[k] === 2);
            return { rank: HAND_RANKS.PAIR, value: 2000 + parseInt(pairRank), cards: sortedCards, name: 'ä¸€å¯¹' };
        }

        // é«˜ç‰Œ
        return { rank: HAND_RANKS.HIGH_CARD, value: 1000 + ranks[0], cards: sortedCards, name: 'é«˜ç‰Œ' };
    }

    // ç®€å•çš„AIå†³ç­–
    function makeAIDecision(player, pot, currentBet, communityCards, phase, playerIndex, dealerIndex) {
        const callAmount = currentBet - player.currentBet;
        const handStrength = evaluateHand([...player.hand, ...communityCards]);
        
        // è®¡ç®—ä½ç½®ï¼ˆ0=æœ€æ—©ä½ç½®ï¼Œ3=æœ€æ™šä½ç½®ï¼‰
        const position = (playerIndex - dealerIndex + 4) % 4;
        const isLatePosition = position >= 2;
        
        // ç¿»ç‰Œå‰ç­–ç•¥
        if (phase === 'preflop') {
            const hand = player.hand;
            let prefloPower = 0;
            
            // è¯„ä¼°èµ·æ‰‹ç‰Œå¼ºåº¦
            const rank1 = hand[0].value;
            const rank2 = hand[1].value;
            const suited = hand[0].suit === hand[1].suit;
            const highCard = Math.max(rank1, rank2);
            const lowCard = Math.min(rank1, rank2);
            const gap = highCard - lowCard;
            
            // å¯¹å­
            if (rank1 === rank2) {
                if (rank1 >= 11) prefloPower = 9; // JJ+
                else if (rank1 >= 9) prefloPower = 7; // 99, TT
                else if (rank1 >= 7) prefloPower = 6; // 77, 88
                else prefloPower = 4; // å°å¯¹å­
            }
            // é«˜ç‰Œç»„åˆ
            else if (highCard === 14) { // A
                if (lowCard >= 11) prefloPower = 8; // AK, AQ, AJ
                else if (lowCard >= 10) prefloPower = 7; // AT
                else if (suited && lowCard >= 5) prefloPower = 5; // A5s+
                else if (lowCard >= 9) prefloPower = 4; // A9o+
                else prefloPower = 2;
            }
            else if (highCard === 13) { // K
                if (lowCard >= 11) prefloPower = 7; // KQ, KJ
                else if (lowCard >= 10) prefloPower = 6; // KT
                else if (suited && lowCard >= 9) prefloPower = 4;
                else prefloPower = 2;
            }
            else if (highCard === 12) { // Q
                if (lowCard >= 11) prefloPower = 6; // QJ
                else if (lowCard >= 10) prefloPower = 5; // QT
                else if (suited && lowCard >= 9) prefloPower = 4;
                else prefloPower = 2;
            }
            else if (highCard >= 11 && lowCard >= 10) {
                prefloPower = 5; // JT
            }
            // åŒèŠ±è¿ç‰Œ
            else if (suited && gap <= 2 && highCard >= 8) {
                prefloPower = 4;
            }
            else if (gap <= 1 && highCard >= 9) {
                prefloPower = 3;
            }
            else {
                prefloPower = 1;
            }
            
            // ä½ç½®åŠ æˆ
            if (isLatePosition) prefloPower += 1;
            
            // æ ¹æ®èµ·æ‰‹ç‰Œå¼ºåº¦å†³ç­–
            const raiseSize = currentBet + Math.floor(pot * 0.3) + 15;
            
            if (prefloPower >= 8) {
                // é¡¶çº§ç‰Œï¼šæ¿€è¿›åŠ æ³¨
                if (callAmount === 0) {
                    return { action: 'raise', amount: raiseSize };
                } else if (callAmount <= player.chips * 0.4) {
                    if (Math.random() > 0.3) {
                        return { action: 'raise', amount: Math.min(player.chips, currentBet * 2 + 20) };
                    } else {
                        return { action: 'call', amount: callAmount };
                    }
                } else {
                    return { action: 'call', amount: callAmount };
                }
            } else if (prefloPower >= 6) {
                // å¼ºç‰Œï¼šç»å¸¸åŠ æ³¨
                if (callAmount === 0 && Math.random() > 0.4) {
                    return { action: 'raise', amount: raiseSize };
                } else if (callAmount <= player.chips * 0.25) {
                    if (Math.random() > 0.5) {
                        return { action: 'raise', amount: Math.min(player.chips, currentBet + 20) };
                    } else {
                        return { action: 'call', amount: callAmount };
                    }
                } else if (callAmount <= player.chips * 0.15) {
                    return { action: 'call', amount: callAmount };
                } else {
                    return { action: 'fold' };
                }
            } else if (prefloPower >= 4) {
                // ä¸­ç­‰ç‰Œï¼šè°¨æ…
                if (callAmount === 0) {
                    if (Math.random() > 0.7) {
                        return { action: 'raise', amount: raiseSize };
                    } else {
                        return { action: 'check' };
                    }
                } else if (callAmount <= player.chips * 0.1) {
                    return { action: 'call', amount: callAmount };
                } else {
                    return { action: 'fold' };
                }
            } else if (prefloPower >= 2) {
                // å¼±ç‰Œï¼šä¾¿å®œçœ‹ç‰Œæˆ–å¼ƒç‰Œ
                if (callAmount === 0) {
                    return { action: 'check' };
                } else if (callAmount <= 10 && Math.random() > 0.6) {
                    return { action: 'call', amount: callAmount };
                } else {
                    return { action: 'fold' };
                }
            } else {
                // åƒåœ¾ç‰Œ
                if (callAmount === 0 && Math.random() > 0.9) {
                    return { action: 'check' };
                } else if (callAmount <= 5 && isLatePosition && Math.random() > 0.8) {
                    return { action: 'call', amount: callAmount };
                } else {
                    return { action: 'fold' };
                }
            }
        }
        
        // ç¿»ç‰Œåç­–ç•¥
        const potOdds = callAmount > 0 ? pot / callAmount : 999;
        
        // é¡¶çº§ç‰Œå‹ï¼ˆä¸‰æ¡ä»¥ä¸Šï¼‰
        if (handStrength.rank >= HAND_RANKS.THREE_OF_KIND) {
            if (callAmount === 0) {
                // æ…¢æ‰“æˆ–ä¸‹æ³¨
                if (handStrength.rank >= HAND_RANKS.FULL_HOUSE || Math.random() > 0.4) {
                    return { action: 'raise', amount: Math.min(player.chips, Math.floor(pot * 0.6) + 15) };
                } else {
                    return { action: 'check' };
                }
            } else if (callAmount <= player.chips * 0.5) {
                if (Math.random() > 0.4) {
                    return { action: 'raise', amount: Math.min(player.chips, currentBet * 2 + 20) };
                } else {
                    return { action: 'call', amount: callAmount };
                }
            } else {
                return { action: 'call', amount: callAmount };
            }
        }
        // ä¸¤å¯¹æˆ–å¥½å¯¹å­
        else if (handStrength.rank >= HAND_RANKS.TWO_PAIR || 
                 (handStrength.rank === HAND_RANKS.PAIR && handStrength.value >= 2010)) {
            if (callAmount === 0) {
                if (Math.random() > 0.5) {
                    return { action: 'raise', amount: Math.min(player.chips, Math.floor(pot * 0.5) + 10) };
                } else {
                    return { action: 'check' };
                }
            } else if (callAmount <= player.chips * 0.3) {
                if (Math.random() > 0.6) {
                    return { action: 'call', amount: callAmount };
                } else if (potOdds >= 3) {
                    return { action: 'call', amount: callAmount };
                } else {
                    return { action: 'fold' };
                }
            } else {
                return { action: 'fold' };
            }
        }
        // ä¸€å¯¹æˆ–å¬ç‰Œ
        else if (handStrength.rank >= HAND_RANKS.PAIR) {
            if (callAmount === 0) {
                if (Math.random() > 0.7) {
                    return { action: 'raise', amount: Math.min(player.chips, Math.floor(pot * 0.4) + 10) };
                } else {
                    return { action: 'check' };
                }
            } else if (potOdds >= 4 && callAmount <= player.chips * 0.2) {
                return { action: 'call', amount: callAmount };
            } else if (callAmount <= 15 && Math.random() > 0.5) {
                return { action: 'call', amount: callAmount };
            } else {
                return { action: 'fold' };
            }
        }
        // é«˜ç‰Œæˆ–å¼±ç‰Œ
        else {
            if (callAmount === 0) {
                // å¶å°”è¯ˆå”¬
                if (Math.random() > 0.85 && isLatePosition) {
                    return { action: 'raise', amount: Math.min(player.chips, Math.floor(pot * 0.5) + 10) };
                } else {
                    return { action: 'check' };
                }
            } else if (potOdds >= 5 && callAmount <= 10) {
                return { action: 'call', amount: callAmount };
            } else {
                return { action: 'fold' };
            }
        }
    }

    // Web Component: æ‰‘å…‹æ¡Œ
    class PokerTable extends HTMLElement {
        constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            this.state = {
                deck: [],
                players: [],
                communityCards: [],
                pot: 0,
                currentPlayerIndex: 0,
                currentBet: 0,
                dealerIndex: 0,
                phase: 'waiting', // waiting, preflop, flop, turn, river, showdown
                lastRaiseIndex: -1,
                gameLog: [],
                showResultModal: false,
                resultMessage: '',
                actionsThisRound: 0,  // æœ¬è½®è¡ŒåŠ¨è®¡æ•°
                lastActionPlayerIndex: -1,  // æœ€åä¸€ä¸ªè¡ŒåŠ¨çš„ç©å®¶ç´¢å¼•
                gameOver: false,  // æ˜¯å¦æ•´åœºæ¸¸æˆç»“æŸï¼ˆç©å®¶ç ´äº§æˆ–æœ€ç»ˆè·èƒœï¼‰
                smallBlindIndex: -1, // å°ç›²ä½ç½®
                bigBlindIndex: -1    // å¤§ç›²ä½ç½®
            };
            this.initGame();
        }

        connectedCallback() {
            this.render();
            this.setupEventListeners();
        }

        initGame() {
            this.state.players = [
                { name: 'ç©å®¶', chips: 200, hand: [], bet: 0, currentBet: 0, folded: false, isAI: false, lastAction: '' },
                { name: 'AI 1', chips: 200, hand: [], bet: 0, currentBet: 0, folded: false, isAI: true, lastAction: '' },
                { name: 'AI 2', chips: 200, hand: [], bet: 0, currentBet: 0, folded: false, isAI: true, lastAction: '' },
                { name: 'AI 3', chips: 200, hand: [], bet: 0, currentBet: 0, folded: false, isAI: true, lastAction: '' }
            ];
            this.state.phase = 'waiting';
            this.state.gameOver = false;
            this.state.smallBlindIndex = -1;
            this.state.bigBlindIndex = -1;
        }

        addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            this.state.gameLog.unshift(`[${timestamp}] ${message}`);
            if (this.state.gameLog.length > 50) {
                this.state.gameLog = this.state.gameLog.slice(0, 50);
            }
        }

        startNewHand() {
            this.addLog('========== æ–°ä¸€å±€å¼€å§‹ ==========');
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è¶³å¤Ÿçš„ç©å®¶
            const playersWithChips = this.state.players.filter(p => p.chips > 0);
            if (playersWithChips.length < 2) {
                this.addLog('æ¸¸æˆç»“æŸï¼šç©å®¶æ•°é‡ä¸è¶³');
                this.state.phase = 'waiting';
                this.render();
                return;
            }
            
            this.state.deck = shuffleDeck(createDeck());
            this.state.communityCards = [];
            this.state.pot = 0;
            this.state.currentBet = 0;
            this.state.phase = 'preflop';
            this.state.showResultModal = false;
            this.state.actionsThisRound = 0;
            this.state.lastActionPlayerIndex = -1;
            this.state.gameOver = false;

            // é‡ç½®ç©å®¶çŠ¶æ€ï¼Œ0ç­¹ç ç©å®¶è‡ªåŠ¨å¼ƒç‰Œï¼ˆåå‡ºï¼‰
            this.state.players.forEach(p => {
                p.hand = [];
                p.bet = 0;
                p.currentBet = 0;
                p.lastAction = '';
                if (p.chips === 0) {
                    p.folded = true;  // 0ç­¹ç ç©å®¶è‡ªåŠ¨å¼ƒç‰Œ
                    this.addLog(`${p.name} ç­¹ç ç”¨å°½ï¼Œåå‡ºæœ¬å±€`);
                } else {
                    p.folded = false;
                }
            });

            // å‘ä¸¤å¼ åº•ç‰Œç»™æœ‰ç­¹ç çš„ç©å®¶
            for (let i = 0; i < 2; i++) {
                this.state.players.forEach(player => {
                    if (player.chips > 0) {
                        player.hand.push(this.state.deck.pop());
                    }
                });
            }

            // æ‰¾åˆ°ç›²æ³¨ä½ï¼ˆè·³è¿‡0ç­¹ç ç©å®¶ï¼‰
            let smallBlindIndex = (this.state.dealerIndex + 1) % 4;
            let attempts = 0;
            while (this.state.players[smallBlindIndex].chips === 0 && attempts < 4) {
                smallBlindIndex = (smallBlindIndex + 1) % 4;
                attempts++;
            }
            
            let bigBlindIndex = (smallBlindIndex + 1) % 4;
            attempts = 0;
            while (this.state.players[bigBlindIndex].chips === 0 && attempts < 4) {
                bigBlindIndex = (bigBlindIndex + 1) % 4;
                attempts++;
            }
            
            // è®°å½•ç›²æ³¨ä½ç½®ï¼Œä¾¿äºåœ¨æ¡Œé¢ä¸Šé«˜äº®
            this.state.smallBlindIndex = smallBlindIndex;
            this.state.bigBlindIndex = bigBlindIndex;
            
            // ä¸‹ç›²æ³¨
            this.placeBet(this.state.players[smallBlindIndex], 5);
            this.placeBet(this.state.players[bigBlindIndex], 10);
            this.state.currentBet = 10;

            this.addLog(`${this.state.players[smallBlindIndex].name} å°ç›²æ³¨ 5`);
            this.addLog(`${this.state.players[bigBlindIndex].name} å¤§ç›²æ³¨ 10`);

            // ä»å¤§ç›²æ³¨åé¢ç¬¬ä¸€ä¸ªæœ‰ç­¹ç çš„ç©å®¶å¼€å§‹
            this.state.currentPlayerIndex = (bigBlindIndex + 1) % 4;
            attempts = 0;
            while (this.state.players[this.state.currentPlayerIndex].chips === 0 && attempts < 4) {
                this.state.currentPlayerIndex = (this.state.currentPlayerIndex + 1) % 4;
                attempts++;
            }

            this.render();
            
            // ä½¿ç”¨ setTimeout ç¡®ä¿æ¸²æŸ“å®Œæˆåå†å¼€å§‹æ¸¸æˆ
            setTimeout(() => {
                this.playRound();
            }, 100);
        }

        placeBet(player, amount) {
            const actualBet = Math.min(amount, player.chips);
            player.chips -= actualBet;
            player.bet += actualBet;
            player.currentBet += actualBet;
            this.state.pot += actualBet;
        }

        async playRound() {
            while (true) {
                // æ´»è·ƒç©å®¶ï¼šæ²¡æœ‰å¼ƒç‰Œçš„ç©å®¶ï¼ˆåŒ…æ‹¬All-inçš„ï¼‰
                const activePlayers = this.state.players.filter(p => !p.folded);
                
                // åªå‰©ä¸€äººï¼Œç»“æŸ
                if (activePlayers.length <= 1) {
                    await this.endHand();
                    return;
                }

                // åˆ¤æ–­æœ¬è½®æ˜¯å¦ç»“æŸ
                // éœ€è¦æ‰€æœ‰è¿˜èƒ½è¡ŒåŠ¨çš„ç©å®¶éƒ½è¡ŒåŠ¨è¿‡ä¸”ä¸‹æ³¨ç›¸åŒ
                const playersCanAct = this.state.players.filter(p => !p.folded && p.chips > 0);
                
                // åªå¯¹ã€Œè¿˜èƒ½ç»§ç»­è¡ŒåŠ¨ã€çš„ç©å®¶æ£€æŸ¥ä¸‹æ³¨æ˜¯å¦ä¸€è‡´
                // å·²ç» All-inï¼ˆchips === 0ï¼‰çš„ç©å®¶ä¸å†è¦æ±‚è·Ÿå¹³å½“å‰æ³¨ï¼Œå¦åˆ™ä¼šåœ¨çŸ­ç­¹ç  All-in æ—¶å¡æ­»
                if (this.state.actionsThisRound >= playersCanAct.length) {
                    const allBetsEqual = playersCanAct.every(p => p.currentBet === this.state.currentBet);
                    if (allBetsEqual) {
                        await this.nextPhase();
                        return;
                    }
                }

                const currentPlayer = this.state.players[this.state.currentPlayerIndex];

                // è·³è¿‡å·²å¼ƒç‰Œæˆ–æ— ç­¹ç çš„ç©å®¶ï¼ˆæ— ç­¹ç çš„è‡ªåŠ¨All-inï¼Œä¸éœ€è¦å†è¡ŒåŠ¨ï¼‰
                if (currentPlayer.folded || currentPlayer.chips === 0) {
                    this.state.currentPlayerIndex = (this.state.currentPlayerIndex + 1) % 4;
                    // æ‰€æœ‰èƒ½è¡ŒåŠ¨çš„ç©å®¶éƒ½è¡ŒåŠ¨å®Œæ—¶ï¼Œä¸Šä¸€æ®µâ€œæœ¬è½®ç»“æŸâ€é€»è¾‘ä¼šè§¦å‘ä¸‹ä¸€é˜¶æ®µ
                    continue;
                }

                if (currentPlayer.isAI) {
                    await this.delay(1000);
                    
                    const beforeBet = this.state.currentBet;
                    this.performAIAction(currentPlayer);
                    const afterBet = this.state.currentBet;
                    
                    // AI è¡ŒåŠ¨åæ›´æ–°è®¡æ•°
                    // å¦‚æœ AI åŠ æ³¨äº†ï¼Œè®¡æ•°åœ¨ performAIAction ä¸­å·²ç»å¤„ç†
                    // å¦åˆ™æ­£å¸¸å¢åŠ è®¡æ•°
                    if (beforeBet === afterBet) {
                        this.state.actionsThisRound++;
                    }
                    
                    this.state.currentPlayerIndex = (this.state.currentPlayerIndex + 1) % 4;
                } else {
                    // ç­‰å¾…ç©å®¶æ“ä½œ
                    this.render();
                    return;
                }
            }
        }

        async nextPhase() {
            // é‡ç½®å½“å‰ä¸‹æ³¨å’Œè¡ŒåŠ¨è®¡æ•°
            this.state.players.forEach(p => p.currentBet = 0);
            this.state.currentBet = 0;
            this.state.actionsThisRound = 0;
            this.state.lastActionPlayerIndex = -1;

            // æ£€æŸ¥èƒ½ç»§ç»­ä¸‹æ³¨çš„ç©å®¶æ•°é‡
            const playersCanAct = this.state.players.filter(p => !p.folded && p.chips > 0);
            const activePlayers = this.state.players.filter(p => !p.folded);
            
            // å¦‚æœåªå‰©0æˆ–1ä¸ªäººèƒ½è¡ŒåŠ¨ï¼Œç›´æ¥å‘å®Œæ‰€æœ‰ç‰Œ
            if (playersCanAct.length <= 1 && activePlayers.length > 1) {
                this.addLog('æ‰€æœ‰ç©å®¶All-inï¼Œå‘å®Œå‰©ä½™å…¬å…±ç‰Œ');
                
                // æ ¹æ®å½“å‰é˜¶æ®µå‘å®Œå‰©ä½™çš„ç‰Œ
                if (this.state.phase === 'preflop') {
                    // å‘ç¿»ç‰Œ
                    this.state.phase = 'flop';
                    for (let i = 0; i < 3; i++) {
                        this.state.communityCards.push(this.state.deck.pop());
                    }
                    const cards = this.state.communityCards.map(c => `${c.rank}${c.suit}`).join(' ');
                    this.addLog(`ç¿»ç‰Œ: ${cards}`);
                    this.render();
                    await this.delay(1500);
                }
                
                if (this.state.phase === 'flop') {
                    // å‘è½¬ç‰Œ
                    this.state.phase = 'turn';
                    this.state.communityCards.push(this.state.deck.pop());
                    const card = this.state.communityCards[3];
                    this.addLog(`è½¬ç‰Œ: ${card.rank}${card.suit}`);
                    this.render();
                    await this.delay(1500);
                }
                
                if (this.state.phase === 'turn') {
                    // å‘æ²³ç‰Œ
                    this.state.phase = 'river';
                    this.state.communityCards.push(this.state.deck.pop());
                    const card = this.state.communityCards[4];
                    this.addLog(`æ²³ç‰Œ: ${card.rank}${card.suit}`);
                    this.render();
                    await this.delay(1500);
                }
                
                // ç›´æ¥æ‘Šç‰Œ
                await this.endHand();
                return;
            }

            // æ­£å¸¸è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
            if (this.state.phase === 'preflop') {
                this.state.phase = 'flop';
                for (let i = 0; i < 3; i++) {
                    this.state.communityCards.push(this.state.deck.pop());
                }
                const cards = this.state.communityCards.map(c => `${c.rank}${c.suit}`).join(' ');
                this.addLog(`ç¿»ç‰Œ: ${cards}`);
            } else if (this.state.phase === 'flop') {
                this.state.phase = 'turn';
                this.state.communityCards.push(this.state.deck.pop());
                const card = this.state.communityCards[3];
                this.addLog(`è½¬ç‰Œ: ${card.rank}${card.suit}`);
            } else if (this.state.phase === 'turn') {
                this.state.phase = 'river';
                this.state.communityCards.push(this.state.deck.pop());
                const card = this.state.communityCards[4];
                this.addLog(`æ²³ç‰Œ: ${card.rank}${card.suit}`);
            } else if (this.state.phase === 'river') {
                await this.endHand();
                return;
            }

            // ä»åº„å®¶å·¦è¾¹ç¬¬ä¸€ä¸ªè¿˜èƒ½è¡ŒåŠ¨çš„ç©å®¶å¼€å§‹
            let nextPlayer = (this.state.dealerIndex + 1) % 4;
            let attempts = 0;
            while ((this.state.players[nextPlayer].folded || this.state.players[nextPlayer].chips === 0) && attempts < 4) {
                nextPlayer = (nextPlayer + 1) % 4;
                attempts++;
            }
            
            this.state.currentPlayerIndex = nextPlayer;
            
            this.render();
            await this.delay(1000);
            this.playRound();
        }

        async endHand() {
            this.state.phase = 'showdown';
            this.render();

            await this.delay(2000);

            const activePlayers = this.state.players.filter(p => !p.folded);
            
            let resultMessage = '';
            
            if (activePlayers.length === 1) {
                const winner = activePlayers[0];
                winner.chips += this.state.pot;
                resultMessage = `${winner.name} èµ¢å¾—åº•æ±  ${this.state.pot} ç­¹ç ï¼ˆå…¶ä»–ç©å®¶å¼ƒç‰Œï¼‰`;
                this.addLog(`${winner.name} èµ¢å¾—åº•æ±  ${this.state.pot}`);
            } else {
                // æ¯”è¾ƒç‰Œå‹
                let bestHand = null;
                let winners = [];

                activePlayers.forEach(player => {
                    const hand = evaluateHand([...player.hand, ...this.state.communityCards]);
                    player.handRank = hand;
                    const cards = player.hand.map(c => `${c.rank}${c.suit}`).join(' ');
                    this.addLog(`${player.name}: ${cards} - ${hand.name}`);
                    
                    if (!bestHand || hand.rank > bestHand.rank || 
                        (hand.rank === bestHand.rank && hand.value > bestHand.value)) {
                        bestHand = hand;
                        winners = [player];
                    } else if (hand.rank === bestHand.rank && hand.value === bestHand.value) {
                        winners.push(player);
                    }
                });

                const winAmount = Math.floor(this.state.pot / winners.length);
                
                if (winners.length === 1) {
                    const winner = winners[0];
                    winner.chips += this.state.pot;
                    resultMessage = `ğŸ‰ ${winner.name} è·èƒœï¼\n\nç‰Œå‹: ${winner.handRank.name}\nèµ¢å¾—: ${this.state.pot} ç­¹ç `;
                    this.addLog(`${winner.name} è·èƒœï¼Œèµ¢å¾— ${this.state.pot} ç­¹ç `);
                } else {
                    const winnerNames = winners.map(w => w.name).join(', ');
                    winners.forEach(w => w.chips += winAmount);
                    resultMessage = `ğŸ¤ å¹³å±€ï¼\n\n${winnerNames}\nç‰Œå‹: ${bestHand.name}\næ¯äººè·å¾—: ${winAmount} ç­¹ç `;
                    this.addLog(`å¹³å±€: ${winnerNames} å„è·å¾— ${winAmount} ç­¹ç `);
                }
            }

            // æ£€æŸ¥æ•´åœºæ¸¸æˆæ˜¯å¦ç»“æŸï¼ˆç©å®¶ç ´äº§æˆ–æˆä¸ºæœ€ç»ˆèµ¢å®¶ï¼‰
            const human = this.state.players[0];
            const ais = this.state.players.slice(1);
            this.state.gameOver = false;

            if (human.chips <= 0) {
                this.state.gameOver = true;
                resultMessage += `\n\nä½ å·²è¾“å…‰æ‰€æœ‰ç­¹ç ï¼Œæ¸¸æˆç»“æŸã€‚\nç‚¹å‡»â€œç»§ç»­â€è¿”å›å¼€å§‹ç•Œé¢é‡æ–°å¼€å±€ã€‚`;
            } else if (ais.every(ai => ai.chips <= 0)) {
                this.state.gameOver = true;
                resultMessage += `\n\næ­å–œä½ æˆ˜èƒœæ‰€æœ‰å¯¹æ‰‹ï¼Œæˆä¸ºæœ€ç»ˆèµ¢å®¶ï¼\nç‚¹å‡»â€œç»§ç»­â€è¿”å›å¼€å§‹ç•Œé¢é‡æ–°å¼€å±€ã€‚`;
            }

            this.state.resultMessage = resultMessage;
            this.state.showResultModal = true;
            this.render();
        }

        performAIAction(player) {
            const decision = makeAIDecision(
                player, 
                this.state.pot, 
                this.state.currentBet, 
                this.state.communityCards,
                this.state.phase,
                this.state.currentPlayerIndex,
                this.state.dealerIndex
            );
            
            if (decision.action === 'fold') {
                player.folded = true;
                player.lastAction = 'å¼ƒç‰Œ';
                this.addLog(`${player.name} å¼ƒç‰Œ`);
            } else if (decision.action === 'check') {
                player.lastAction = 'è¿‡ç‰Œ';
                this.addLog(`${player.name} è¿‡ç‰Œ`);
            } else if (decision.action === 'call') {
                this.placeBet(player, decision.amount);
                player.lastAction = `è·Ÿæ³¨ ${decision.amount}`;
                this.addLog(`${player.name} è·Ÿæ³¨ ${decision.amount}`);
            } else if (decision.action === 'raise') {
                this.placeBet(player, decision.amount);
                this.state.currentBet = player.currentBet;
                player.lastAction = `åŠ æ³¨åˆ° ${player.currentBet}`;
                this.addLog(`${player.name} åŠ æ³¨åˆ° ${player.currentBet}`);
                // åŠ æ³¨æ—¶é‡ç½®è¡ŒåŠ¨è®¡æ•°ä¸º1ï¼ˆåŠ æ³¨è€…æœ¬äººå·²è¡ŒåŠ¨ï¼‰
                this.state.actionsThisRound = 1;
            }
        }

        playerAction(action, amount = 0) {
            const player = this.state.players[this.state.currentPlayerIndex];
            
            if (action === 'fold') {
                player.folded = true;
                player.lastAction = 'å¼ƒç‰Œ';
                this.addLog(`${player.name} å¼ƒç‰Œ`);
                this.state.actionsThisRound++;
            } else if (action === 'check') {
                player.lastAction = 'è¿‡ç‰Œ';
                this.addLog(`${player.name} è¿‡ç‰Œ`);
                this.state.actionsThisRound++;
            } else if (action === 'call') {
                const callAmount = this.state.currentBet - player.currentBet;
                this.placeBet(player, callAmount);
                player.lastAction = `è·Ÿæ³¨ ${callAmount}`;
                this.addLog(`${player.name} è·Ÿæ³¨ ${callAmount}`);
                this.state.actionsThisRound++;
            } else if (action === 'raise') {
                this.placeBet(player, amount);
                this.state.currentBet = player.currentBet;
                player.lastAction = `åŠ æ³¨åˆ° ${player.currentBet}`;
                this.addLog(`${player.name} åŠ æ³¨åˆ° ${player.currentBet}`);
                // åŠ æ³¨æ—¶é‡ç½®è¡ŒåŠ¨è®¡æ•°ä¸º1ï¼ˆåŠ æ³¨è€…æœ¬äººå·²è¡ŒåŠ¨ï¼‰
                this.state.actionsThisRound = 1;
            }

            this.state.currentPlayerIndex = (this.state.currentPlayerIndex + 1) % 4;
            this.render();
            
            // ä½¿ç”¨ setTimeout ç¡®ä¿æ¸²æŸ“å®Œæˆåå†ç»§ç»­æ¸¸æˆ
            setTimeout(() => {
                this.playRound();
            }, 100);
        }

        delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        setupEventListeners() {
            const foldBtn = this.shadowRoot.querySelector('.btn-fold');
            const checkBtn = this.shadowRoot.querySelector('.btn-check');
            const callBtn = this.shadowRoot.querySelector('.btn-call');
            const raiseBtn = this.shadowRoot.querySelector('.btn-raise');

            if (foldBtn) foldBtn.addEventListener('click', () => this.playerAction('fold'));
            if (checkBtn) checkBtn.addEventListener('click', () => this.playerAction('check'));
            if (callBtn) callBtn.addEventListener('click', () => this.playerAction('call'));
            if (raiseBtn) raiseBtn.addEventListener('click', () => {
                const raiseAmount = this.state.currentBet + 20;
                this.playerAction('raise', raiseAmount);
            });
        }

        render() {
            const player = this.state.players[0];
            const isPlayerTurn = this.state.currentPlayerIndex === 0 && !player.folded && player.chips > 0;
            const callAmount = this.state.currentBet - player.currentBet;
            const isStealth = document.body.classList.contains('stealth-mode');

            // èŠ±è‰²æ˜ å°„
            const suitMap = { 'â™ ': 'S', 'â™¥': 'H', 'â™¦': 'D', 'â™£': 'C' };

            if (isStealth) {
                // ç®€æ´æ–‡æœ¬æ¨¡å¼
                this.shadowRoot.innerHTML = `
                    <style>
                        :host {
                            display: block;
                            width: 100%;
                            height: 100%;
                            background: white;
                            font-family: 'Courier New', monospace;
                            color: #333;
                        }

                        .stealth-container {
                            max-width: 900px;
                            margin: 0 auto;
                            padding: 40px 20px;
                            background: white;
                        }

                        .section {
                            margin-bottom: 25px;
                            padding: 15px;
                            border: 1px solid #e0e0e0;
                            background: #fafafa;
                        }

                        .section-title {
                            font-size: 12px;
                            color: #888;
                            margin-bottom: 10px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        }

                        .data-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px solid #f0f0f0;
                            font-size: 13px;
                        }

                        .data-row:last-child {
                            border-bottom: none;
                        }

                        .label {
                            color: #666;
                            font-weight: 500;
                        }

                        .value {
                            color: #333;
                            font-family: monospace;
                        }

                        .cards-text {
                            font-family: monospace;
                            letter-spacing: 2px;
                            color: #333;
                            font-size: 14px;
                            font-weight: bold;
                        }

                        .card-red {
                            color: #f00;
                        }

                        .player-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 15px;
                        }

                        .player-card {
                            border: 1px solid #e0e0e0;
                            padding: 12px;
                            background: white;
                        }

                        .player-card.active {
                            border-color: #999;
                            background: #f5f5f5;
                        }

                        .player-card.folded {
                            opacity: 0.4;
                        }

                        .player-name {
                            font-weight: 600;
                            margin-bottom: 8px;
                            font-size: 13px;
                            color: #333;
                        }

                        .player-stats {
                            font-size: 11px;
                            color: #666;
                            line-height: 1.6;
                        }

                        .player-stats span {
                            font-size: 14px;
                            font-weight: bold;
                        }

                        .action-buttons {
                            display: flex;
                            gap: 10px;
                            margin-top: 20px;
                        }

                        button {
                            flex: 1;
                            padding: 10px;
                            border: 1px solid #ccc;
                            background: white;
                            color: #333;
                            cursor: pointer;
                            font-size: 12px;
                            font-family: inherit;
                        }

                        button:hover:not(:disabled) {
                            background: #f0f0f0;
                        }

                        button:disabled {
                            opacity: 0.3;
                            cursor: not-allowed;
                        }

                        .status-bar {
                            background: #f5f5f5;
                            padding: 10px 15px;
                            margin-bottom: 20px;
                            border-left: 3px solid #999;
                            font-size: 12px;
                            color: #666;
                        }

                        .start-button {
                            width: 100%;
                            padding: 15px;
                            border: 1px solid #999;
                            background: #f5f5f5;
                            color: #333;
                            cursor: pointer;
                            font-size: 14px;
                        }

                        .start-button:hover {
                            background: #e0e0e0;
                        }

                        .modal-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 1000;
                        }

                        .modal {
                            background: white;
                            padding: 30px;
                            border-radius: 8px;
                            border: 1px solid #ccc;
                            max-width: 400px;
                            text-align: center;
                        }

                        .modal-title {
                            font-size: 18px;
                            font-weight: 600;
                            margin-bottom: 15px;
                            color: #333;
                        }

                        .modal-content {
                            white-space: pre-line;
                            margin-bottom: 20px;
                            line-height: 1.6;
                            color: #666;
                        }

                        .modal-button {
                            padding: 10px 30px;
                            background: #333;
                            color: white;
                            border: none;
                            cursor: pointer;
                            font-size: 14px;
                        }

                        .modal-button:hover {
                            background: #555;
                        }

                        .game-log {
                            max-height: 200px;
                            overflow-y: auto;
                            font-size: 11px;
                            line-height: 1.5;
                            color: #666;
                        }

                        .log-entry {
                            padding: 4px 0;
                            border-bottom: 1px solid #f0f0f0;
                        }

                        .log-entry:last-child {
                            border-bottom: none;
                        }
                    </style>

                    <div class="stealth-container">
                        ${this.state.phase === 'waiting' ? `
                            <div class="section">
                                <div class="section-title">Game Status</div>
                                <button class="start-button btn-start">Start New Game</button>
                            </div>
                        ` : `
                            <div class="status-bar">
                                Phase: ${this.state.phase.toUpperCase()} | Pot: ${this.state.pot} | Bet: ${this.state.currentBet}
                            </div>

                            <div class="section">
                                <div class="section-title">Community Cards</div>
                                <div class="cards-text">
                                    ${this.state.communityCards.length > 0 ? 
                                        this.state.communityCards.map(c => {
                                            const isRed = c.suit === 'â™¥' || c.suit === 'â™¦';
                                            return `<span class="${isRed ? 'card-red' : ''}">${c.rank}${suitMap[c.suit]}</span>`;
                                        }).join(' ') : 
                                        '---'}
                                </div>
                            </div>

                            <div class="section">
                                <div class="section-title">Players</div>
                                <div class="player-grid">
                                    ${this.state.players.map((p, index) => {
                                        const isCurrentTurn = index === this.state.currentPlayerIndex && !p.folded && p.chips > 0;
                                        const showCards = (index === 0 || this.state.phase === 'showdown') && p.hand.length > 0;
                                        const isBusted = p.chips === 0;
                                        
                                        return `
                                            <div class="player-card ${isCurrentTurn ? 'active' : ''} ${p.folded || isBusted ? 'folded' : ''}">
                                                <div class="player-name">${p.name}${isBusted ? ' (å·²åå‡º)' : ''}</div>
                                                <div class="player-stats">
                                                    Chips: ${p.chips} | Bet: ${p.bet}<br>
                                                    Hand: ${isBusted ? '---' : (showCards ? 
                                                        p.hand.map(c => {
                                                            const isRed = c.suit === 'â™¥' || c.suit === 'â™¦';
                                                            return `<span class="${isRed ? 'card-red' : ''}">${c.rank}${suitMap[c.suit]}</span>`;
                                                        }).join(' ') : 
                                                        p.hand.length > 0 ? '** **' : '--')}
                                                    ${p.handRank && this.state.phase === 'showdown' ? `<br>Result: ${p.handRank.name}` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            ${isPlayerTurn && this.state.phase !== 'showdown' ? `
                                <div class="section">
                                    <div class="section-title">Your Action</div>
                                    <div class="action-buttons">
                                        <button class="btn-fold">Fold</button>
                                        ${callAmount === 0 ? 
                                            `<button class="btn-check">Check</button>` : 
                                            `<button class="btn-call">Call ${callAmount}</button>`
                                        }
                                        <button class="btn-raise">Raise ${this.state.currentBet + 20}</button>
                                    </div>
                                </div>
                            ` : ''}
                        `}

                        ${this.state.gameLog.length > 0 ? `
                            <div class="section">
                                <div class="section-title">Game Log</div>
                                <div class="game-log">
                                    ${this.state.gameLog.map(log => `
                                        <div class="log-entry">${log}</div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    ${this.state.showResultModal ? `
                        <div class="modal-overlay">
                            <div class="modal">
                                <div class="modal-title">Game Result</div>
                                <div class="modal-content">${this.state.resultMessage}</div>
                                <button class="modal-button btn-continue">Continue</button>
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                // æ­£å¸¸æ¸¸æˆæ¨¡å¼
                this.shadowRoot.innerHTML = `
                <style>
                    :host {
                        display: block;
                        width: 100%;
                        height: 100%;
                        --bg-color: #1a472a;
                        --text-color: white;
                        --card-bg: white;
                        --border-color: #d4af37;
                        --chip-color: #d4af37;
                    }

                    .table-container {
                        width: 100%;
                        height: 100%;
                        background: var(--bg-color);
                        position: relative;
                        display: flex;
                        align-items: flex-start;
                        justify-content: center;
                        margin-top: 50px;
                    }

                    .table {
                        width: 800px;
                        height: 600px;
                        background: var(--bg-color);
                        border: 3px solid var(--border-color);
                        border-radius: 250px;
                        position: relative;
                    }

                    .community-cards {
                        position: absolute;
                        top: 48%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        display: flex;
                        gap: 10px;
                    }

                    .card {
                        width: 56px;
                        height: 80px;
                        background: var(--card-bg);
                        border: 2px solid #333;
                        border-radius: 5px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        font-weight: bold;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    }

                    .card.red {
                        color: #d32f2f;
                    }

                    .card.black {
                        color: #000;
                    }

                    .card.back {
                        background: linear-gradient(45deg, #1976d2 25%, #64b5f6 25%, #64b5f6 50%, #1976d2 50%, #1976d2 75%, #64b5f6 75%, #64b5f6);
                        background-size: 20px 20px;
                    }

                    .player-seat {
                        position: absolute;
                        width: 150px;
                        text-align: center;
                    }

                    .player-seat.bottom {
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                    }

                    .player-seat.top {
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                    }

                    .player-seat.left {
                        left: 50px;
                        top: 50%;
                        transform: translateY(-50%);
                    }

                    .player-seat.right {
                        right: 50px;
                        top: 50%;
                        transform: translateY(-50%);
                    }

                    .player-info {
                        color: var(--text-color);
                        font-size: 14px;
                        margin-bottom: 6px;
                        background: rgba(0,0,0,0.5);
                        padding: 5px 10px;
                        border-radius: 5px;
                    }

                    .blind-badge {
                        display: inline-block;
                        margin-left: 6px;
                        padding: 2px 6px;
                        border-radius: 10px;
                        background: #d4af37;
                        color: #000;
                        font-size: 10px;
                        font-weight: bold;
                    }

                    .player-cards {
                        display: flex;
                        gap: 5px;
                        justify-content: center;
                    }

                    .controls {
                        position: absolute;
                        top: 61%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        display: flex;
                        gap: 10px;
                        background: rgba(0,0,0,0.6);
                        padding: 8px 12px;
                        border-radius: 8px;
                    }

                    button {
                        padding: 10px 20px;
                        font-size: 16px;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        background: #4caf50;
                        color: white;
                        transition: background 0.3s;
                    }

                    button:hover:not(:disabled) {
                        background: #45a049;
                    }

                    button:disabled {
                        background: #ccc;
                        cursor: not-allowed;
                    }

                    .btn-fold {
                        background: #f44336;
                    }

                    .btn-fold:hover:not(:disabled) {
                        background: #da190b;
                    }

                    .btn-raise {
                        background: #ff9800;
                    }

                    .btn-raise:hover:not(:disabled) {
                        background: #e68900;
                    }

                    .pot-info {
                        position: absolute;
                        top: 200px;
                        left: 50%;
                        transform: translateX(-50%);
                        color: var(--chip-color);
                        font-size: 20px;
                        font-weight: bold;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                    }

                    .current-turn {
                        box-shadow: 0 0 20px var(--chip-color);
                    }

                    .folded {
                        opacity: 0.5;
                    }

                    .hand-result {
                        font-size: 12px;
                        color: var(--chip-color);
                        margin-top: 5px;
                    }

                    .player-action {
                        font-size: 12px;
                        color: #f5f5f5;
                        margin-top: 2px;
                        opacity: 0.85;
                    }

                    .start-overlay {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        text-align: center;
                    }

                    .btn-start {
                        padding: 20px 40px;
                        font-size: 24px;
                        background: #d4af37;
                        color: #000;
                        font-weight: bold;
                    }

                    .btn-start:hover {
                        background: #c9a42c;
                    }

                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    }

                    .modal {
                        background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
                        padding: 40px;
                        border-radius: 15px;
                        border: 3px solid #d4af37;
                        max-width: 500px;
                        text-align: center;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    }

                    .modal-title {
                        font-size: 28px;
                        font-weight: bold;
                        margin-bottom: 20px;
                        color: #d4af37;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
                    }

                    .modal-content {
                        white-space: pre-line;
                        margin-bottom: 30px;
                        line-height: 1.8;
                        color: white;
                        font-size: 18px;
                    }

                    .modal-button {
                        padding: 15px 40px;
                        background: #d4af37;
                        color: #000;
                        border: none;
                        cursor: pointer;
                        font-size: 18px;
                        font-weight: bold;
                        border-radius: 5px;
                    }

                    .modal-button:hover {
                        background: #c9a42c;
                    }

                    .game-log-panel {
                        position: fixed;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        background: rgba(0, 0, 0, 0.9);
                        border-top: 2px solid #d4af37;
                        max-height: 150px;
                        overflow-y: auto;
                        padding: 10px 20px;
                        font-family: 'Courier New', monospace;
                    }

                    .log-entry {
                        color: #d4af37;
                        font-size: 12px;
                        padding: 3px 0;
                        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
                    }

                    .log-entry:last-child {
                        border-bottom: none;
                    }
                </style>

                <div class="table-container">
                    <div class="table">
                        ${this.state.phase === 'waiting' ? `
                            <div class="start-overlay">
                                <button class="btn-start">å¼€å§‹æ¸¸æˆ</button>
                            </div>
                        ` : `
                        <!-- åº•æ±  -->
                        <div class="pot-info">åº•æ± : ${this.state.pot}</div>

                        <!-- å…¬å…±ç‰Œ -->
                        <div class="community-cards">
                            ${this.state.communityCards.map(card => `
                                <div class="card ${card.suit === 'â™¥' || card.suit === 'â™¦' ? 'red' : 'black'}">
                                    <div>${card.rank}</div>
                                    <div>${card.suit}</div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- ç©å®¶ä½ç½® -->
                        ${this.state.players.map((p, index) => {
                            const positions = ['bottom', 'left', 'top', 'right'];
                            const isCurrentTurn = index === this.state.currentPlayerIndex && !p.folded;
                            const showCards = (index === 0 || this.state.phase === 'showdown') && p.hand.length > 0;
                            const isSmallBlind = this.state.phase !== 'waiting' && index === this.state.smallBlindIndex;
                            const isBigBlind = this.state.phase !== 'waiting' && index === this.state.bigBlindIndex;
                            
                            return `
                                <div class="player-seat ${positions[index]} ${isCurrentTurn ? 'current-turn' : ''} ${p.folded ? 'folded' : ''}">
                                    <div class="player-info">
                                        <div>
                                            ${p.name}
                                            ${isSmallBlind ? '<span class="blind-badge">å°ç›²</span>' : ''}
                                            ${isBigBlind ? '<span class="blind-badge">å¤§ç›²</span>' : ''}
                                        </div>
                                        <div>ç­¹ç : ${p.chips}</div>
                                        <div>ä¸‹æ³¨: ${p.bet}</div>
                                        <div class="player-action">
                                            åŠ¨ä½œ: ${
                                                p.lastAction 
                                                    ? p.lastAction 
                                                    : (p.folded 
                                                        ? 'å·²å¼ƒç‰Œ' 
                                                        : (this.state.phase === 'waiting' 
                                                            ? '-' 
                                                            : (index === this.state.currentPlayerIndex 
                                                                ? 'è½®åˆ°è¡ŒåŠ¨' 
                                                                : 'ç­‰å¾…æœ¬è½®è¡ŒåŠ¨')))
                                            }
                                        </div>
                                        ${p.handRank && this.state.phase === 'showdown' ? `
                                            <div class="hand-result">${p.handRank.name}</div>
                                        ` : ''}
                                    </div>
                                    <div class="player-cards">
                                        ${p.hand.map((card, i) => {
                                            if (showCards) {
                                                return `
                                                    <div class="card ${card.suit === 'â™¥' || card.suit === 'â™¦' ? 'red' : 'black'}">
                                                        <div>${card.rank}</div>
                                                        <div>${card.suit}</div>
                                                    </div>
                                                `;
                                            } else if (p.hand.length > 0) {
                                                return `<div class="card back"></div>`;
                                            }
                                            return '';
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}

                        <!-- æ§åˆ¶æŒ‰é’® -->
                        ${isPlayerTurn && this.state.phase !== 'showdown' ? `
                            <div class="controls">
                                <button class="btn-fold">å¼ƒç‰Œ</button>
                                ${callAmount === 0 ? 
                                    `<button class="btn-check">è¿‡ç‰Œ</button>` : 
                                    `<button class="btn-call">è·Ÿæ³¨ (${callAmount})</button>`
                                }
                                <button class="btn-raise">åŠ æ³¨ (${this.state.currentBet + 20})</button>
                            </div>
                        ` : ''}
                        `}
                    </div>
                </div>

                ${this.state.gameLog.length > 0 ? `
                    <div class="game-log-panel">
                        ${this.state.gameLog.slice(0, 10).map(log => `
                            <div class="log-entry">${log}</div>
                        `).join('')}
                    </div>
                ` : ''}

                ${this.state.showResultModal ? `
                    <div class="modal-overlay">
                        <div class="modal">
                            <div class="modal-title">æœ¬å±€ç»“æŸ</div>
                            <div class="modal-content">${this.state.resultMessage}</div>
                            <button class="modal-button btn-continue">ç»§ç»­æ¸¸æˆ</button>
                        </div>
                    </div>
                ` : ''}
            `;
            }

            this.setupEventListeners();
        }

        setupEventListeners() {
            const foldBtn = this.shadowRoot.querySelector('.btn-fold');
            const checkBtn = this.shadowRoot.querySelector('.btn-check');
            const callBtn = this.shadowRoot.querySelector('.btn-call');
            const raiseBtn = this.shadowRoot.querySelector('.btn-raise');
            const startBtn = this.shadowRoot.querySelector('.btn-start');
            const continueBtn = this.shadowRoot.querySelector('.btn-continue');

            if (foldBtn) foldBtn.addEventListener('click', () => this.playerAction('fold'));
            if (checkBtn) checkBtn.addEventListener('click', () => this.playerAction('check'));
            if (callBtn) callBtn.addEventListener('click', () => this.playerAction('call'));
            if (raiseBtn) raiseBtn.addEventListener('click', () => {
                const raiseAmount = this.state.currentBet + 20;
                this.playerAction('raise', raiseAmount);
            });
            if (startBtn) startBtn.addEventListener('click', () => this.startNewHand());
            if (continueBtn) continueBtn.addEventListener('click', () => {
                if (this.state.gameOver) {
                    // æ•´åœºæ¸¸æˆç»“æŸï¼šå›åˆ°å¼€å§‹ç•Œé¢ï¼Œé‡ç½®ä¸ºåˆå§‹çŠ¶æ€
                    this.state.showResultModal = false;
                    this.state.gameLog = [];
                    this.state.deck = [];
                    this.state.communityCards = [];
                    this.state.pot = 0;
                    this.state.currentBet = 0;
                    this.state.currentPlayerIndex = 0;
                    this.state.dealerIndex = 0;
                    this.state.actionsThisRound = 0;
                    this.state.lastActionPlayerIndex = -1;
                    this.state.smallBlindIndex = -1;
                    this.state.bigBlindIndex = -1;
                    this.initGame();
                    this.render();
                } else {
                    // æ­£å¸¸å¤šå±€æ¸¸æˆï¼šç»§ç»­ä¸‹ä¸€æ‰‹ç‰Œ
                    this.state.dealerIndex = (this.state.dealerIndex + 1) % 4;
                    this.startNewHand();
                }
            });
        }
    }

    customElements.define('poker-table', PokerTable);

    // æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
    function toggleMode() {
        document.body.classList.toggle('stealth-mode');
        const btn = document.querySelector('.mode-toggle');
        const table = document.querySelector('poker-table');
        
        if (document.body.classList.contains('stealth-mode')) {
            btn.textContent = 'æ¸¸æˆæ¨¡å¼';
        } else {
            btn.textContent = 'ç®€æ´æ¨¡å¼';
        }
        
        // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM æ›´æ–°åå†æ¸²æŸ“
        setTimeout(() => {
            if (table) {
                table.render();
            }
        }, 0);
    }
</script>

</body>
</html>